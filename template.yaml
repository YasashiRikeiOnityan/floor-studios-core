AWSTemplateFormatVersion: "2010-09-09"

Transform: AWS::Serverless-2016-10-31

Description: Floor Studios Core

Globals:
  Function:
    Timeout: 10
    Runtime: python3.13
    Architectures:
      - x86_64
    LoggingConfig:
      ApplicationLogLevel: INFO
      LogFormat: JSON
      SystemLogLevel: INFO

Parameters:
  # プロジェクト名
  ProjectName:
    Type: String
    Default: floor-studios
  # プロジェクトタイプ
  ProjectType:
    Type: String
    Default: core
  # 環境
  Environment:
    Type: String
    Default: main
  # ドメイン名
  DomainName:
    Type: String
    Default: floor-studios.com
  # ホストゾーンID
  HostedZoneId:
    Type: String
    Default: Z00033452JLLJGRAM0F3Y

Resources:
  #########################################################
  # API用の証明書の定義
  #########################################################
  ApiCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Sub "*.api.${DomainName}"
      DomainValidationOptions:
        - DomainName: !Sub "*.api.${DomainName}"
          HostedZoneId: !Ref HostedZoneId
      KeyAlgorithm: RSA_2048
      ValidationMethod: DNS
      CertificateTransparencyLoggingPreference: ENABLED

  #########################################################
  # Cognito UserPoolの定義
  #########################################################
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub userpool-${ProjectName}-${ProjectType}-${Environment}
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
      AutoVerifiedAttributes:
        - email
      # メールアドレスをユーザー名として使用する
      UsernameAttributes:
        - email
      # ユーザー名の大文字小文字を区別しない
      UsernameConfiguration:
        CaseSensitive: false
      # Cognitoのデフォルトメール送信を使用する
      EmailConfiguration:
        EmailSendingAccount: COGNITO_DEFAULT
      # メールアドレスを使用してアカウントを確認する
      VerificationMessageTemplate:
        DefaultEmailOption: CONFIRM_WITH_CODE
        EmailSubject: "Floor Studios - Email Verification"
        EmailMessage: | 
          Verification Code: {####}<br><br>
          Please enter this code to verify your email address.<br><br>
          This code is valid for 10 minutes.
      # ユーザー属性の定義
      Schema:
        - Name: email
          AttributeDataType: String
          Mutable: true
          Required: true
        - Name: tenant_id
          AttributeDataType: String
          Mutable: true
          Required: false
      Policies:
        # パスワードポリシーの定義
        PasswordPolicy:
          MinimumLength: 6
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false
          RequireUppercase: false
          TemporaryPasswordValidityDays: 7
      LambdaConfig:
        PostConfirmation: !GetAtt CognitoPostConfirmation.Arn

  #########################################################
  # Cognito UserPool Clientの定義
  #########################################################
  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref CognitoUserPool
      ClientName: !Sub userpool-client-${ProjectName}-${ProjectType}-${Environment}
      GenerateSecret: false
      PreventUserExistenceErrors: ENABLED
      ExplicitAuthFlows:
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH

  #########################################################
  # Cognito Identity Poolの定義
  #########################################################
  CognitoIdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub identitypool-${ProjectName}-${ProjectType}-${Environment}
      AllowUnauthenticatedIdentities: false
      CognitoIdentityProviders:
        - ProviderName: !Sub "cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}"
          ClientId: !Ref CognitoUserPoolClient
  
  #########################################################
  # Cognito Identity PoolのIAMロールの定義
  #########################################################
  CognitoIdentityPoolRole:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref CognitoIdentityPool
      Roles:
        authenticated: !GetAtt CognitoAuthRole.Arn
        unauthenticated: !GetAtt CognitoUnauthRole.Arn
  
  #########################################################
  # 認証済みユーザー用のIAMロール
  #########################################################
  CognitoAuthRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-cognito-auth
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                "cognito-identity.amazonaws.com:aud": !Ref CognitoIdentityPool
              ForAnyValue:StringLike:
                "cognito-identity.amazonaws.com:amr": authenticated
      Policies:
        - PolicyName: CognitoAuthorizedPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource: !Sub ${S3BucketSpecifications.Arn}/*
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !GetAtt S3BucketSpecifications.Arn

  ######################################################### 
  # 未認証ユーザー用のIAMロール
  # 使用する意図はないが用意しておく
  #########################################################
  CognitoUnauthRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-cognito-unauth
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                "cognito-identity.amazonaws.com:aud": !Ref CognitoIdentityPool
              ForAnyValue:StringLike:
                "cognito-identity.amazonaws.com:amr": unauthenticated
      Policies:
        - PolicyName: CognitoUnauthorizedPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow 
                Action:
                  - s3:GetObject
                Resource: !Sub "arn:${AWS::Partition}:s3:::${S3BucketSpecifications}/public/*"

  #########################################################
  # のS3バケット
  #########################################################
  S3BucketStaticAssets:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub bucket-${ProjectName}-${ProjectType}-${Environment}-static-assets
      CorsConfiguration:
        CorsRules:
          - AllowedMethods:
              - GET
              - PUT
              - DELETE
            AllowedOrigins:
              - !Sub https://${DomainName}
              - http://localhost:3000
            AllowedHeaders:
              - "*"

  #########################################################
  # 仕様書をテナントごとに保存するためのS3バケット
  #########################################################
  S3BucketSpecifications:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub bucket-${ProjectName}-${ProjectType}-${Environment}-specifications
      CorsConfiguration:
        CorsRules:
          - AllowedMethods:
              - GET
              - PUT
              - DELETE
            AllowedOrigins:
              - !Sub https://${DomainName}
              - http://localhost:3000
            AllowedHeaders:
              - "*"

  #########################################################
  # Cognitoトリガー用Lambda関数
  #########################################################
  CognitoPostConfirmation:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-cognito-post-confirmation
      CodeUri: src/common/CognitoPostConfirmation/
      Handler: app.lambda_handler
      Environment:
        Variables:
          TENANTS_TABLE_NAME: !Ref TenantsTable
          USERS_TABLE_NAME: !Ref UsersTable
      Role: !GetAtt CognitoPostConfirmationRole.Arn

  CognitoPostConfirmationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-cognito-post-confirmation
      RetentionInDays: 14

  CognitoPostConfirmationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-cognito-post-confirmation
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-cognito-post-confirmation
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                Resource: !GetAtt TenantsTable.Arn
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                Resource: !GetAtt UsersTable.Arn
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-cognito-post-confirmation:*
              - Effect: Allow
                Action:
                  - cognito-idp:AdminUpdateUserAttributes
                # 循環定義にならないように広い範囲で指定する（微妙...)
                Resource: !Sub arn:${AWS::Partition}:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*

  #########################################################
  # CognitoにLambda関数の呼び出し権限を付与
  #########################################################
  CognitoPostConfirmationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref CognitoPostConfirmation
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt CognitoUserPool.Arn

  #########################################################
  # API定義
  #########################################################
  FloorStudiosApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub api-${ProjectName}-${ProjectType}-${Environment}
      StageName: !Ref Environment
      Domain:
        DomainName: !Sub "${Environment}.api.${DomainName}"
        CertificateArn: !Ref ApiCertificate
        EndpointConfiguration: REGIONAL
        Route53:
          HostedZoneId: !Ref HostedZoneId
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Access-Control-Allow-Origin,Access-Control-Allow-Headers,Access-Control-Allow-Methods'"
        AllowOrigin: "'*'"
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt CognitoUserPool.Arn
        # OPTIONSリクエストにデフォルトのAuthorizerを追加しない
        AddDefaultAuthorizerToCorsPreflight: false
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Access-Control-Allow-Origin,Access-Control-Allow-Headers,Access-Control-Allow-Methods'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Access-Control-Allow-Origin,Access-Control-Allow-Headers,Access-Control-Allow-Methods'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"

  #########################################################
  # tenant Lambda関数の定義
  #########################################################
  TenantFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-tenant
      CodeUri: src/api/ApiTenant/
      Handler: app.lambda_handler
      Environment:
        Variables:
          TENANTS_TABLE_NAME: !Ref TenantsTable
      Role: !GetAtt TenantFunctionRole.Arn
      Layers:
        - !Ref CommonLayer
      Events:
        GetTenant:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/tenant
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        PutTenant:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/tenant
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer

  #########################################################
  # tenant Lambda関数のロググループの定義
  #########################################################
  TenantFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-tenant
      RetentionInDays: 14

  #########################################################
  # tenant Lambda関数のロールの定義
  #########################################################
  TenantFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-tenant
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-tenant
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                Resource: !GetAtt TenantsTable.Arn
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-tenant:*

  #########################################################
  # users Lambda関数の定義
  #########################################################
  UsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-users
      CodeUri: src/api/ApiUsers/
      Handler: get.lambda_handler
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTable
      Role: !GetAtt UsersFuctionRole.Arn
      Events:
        GetUsers:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/users
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        # PostUsers:
        #   Type: Api
        #   Properties:
        #     RestApiId: !Ref FloorStudiosApi
        #     Path: /v1/users
        #     Method: post
        #     Auth:
        #       Authorizer: CognitoAuthorizer

  #########################################################
  UsersFuctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-users
      RetentionInDays: 14

  #########################################################
  # users Lambda関数のロールの定義
  #########################################################
  UsersFuctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-users
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-users
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-users:*
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                Resource: !GetAtt UsersTable.Arn

  #########################################################
  # users/{userId} Lambda関数の定義 
  #########################################################
  UsersUserIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-users-user-id
      CodeUri: src/api/ApiUsersUserId/
      Handler: app.lambda_handler
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTable
          S3_BUCKET_STATIC_ASSETS: !Ref S3BucketSpecifications
      Role: !GetAtt UsersUserIdFunctionRole.Arn
      Events:
        GetUsersUserId:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/users/{user_id}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        PutUsersUserId:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/users/{user_id}
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer

  #########################################################
  # users/{userId} Lambda関数のロググループの定義
  #########################################################
  UsersUserIdFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-users-user-id
      RetentionInDays: 14

  #########################################################
  # users/{userId} Lambda関数のロールの定義
  #########################################################
  UsersUserIdFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-users-user-id
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-users-user-id
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-users-user-id:*
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:PutItem
                  - dynamodb:DeleteItem
                Resource: !GetAtt UsersTable.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub ${S3BucketSpecifications.Arn}/*

  #########################################################
  # specifications Lambda関数の定義
  #########################################################
  SpecificationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-specifications
      CodeUri: src/api/ApiSpecifications/
      Handler: app.lambda_handler
      Environment:
        Variables:
          SPECIFICATIONS_TABLE_NAME: !Ref SpecificationsTable
          USERS_TABLE_NAME: !Ref UsersTable
          CREATE_SPECIFICATION_SQS_QUEUE_URL: !Ref CreateSpecificationSQSQueue
      Role: !GetAtt SpecificationsFunctionRole.Arn
      Layers:
        - !Ref CommonLayer
      Events:
        GetSpecifications:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/specifications
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        PostSpecifications:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/specifications
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  SpecificationsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-specifications
      RetentionInDays: 14

  #########################################################
  # specifications Lambda関数のロールの定義
  #########################################################
  SpecificationsFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-specifications
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-specifications
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-specifications:*
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                Resource: !GetAtt SpecificationsTable.Arn
              - Effect: Allow
                Action:
                  - dynamodb:Query
                Resource: 
                  - !GetAtt SpecificationsTable.Arn
                  - !Sub ${SpecificationsTable.Arn}/index/TenantIdIndex
                  - !Sub ${SpecificationsTable.Arn}/index/SpecificationGroupIdIndex
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                Resource: !GetAtt UsersTable.Arn
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource: !GetAtt CreateSpecificationSQSQueue.Arn

  #########################################################
  # specifications/{specificationId} Lambda関数の定義
  #########################################################
  SpecificationsSpecificationIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-specifications-specification-id
      CodeUri: src/api/ApiSpecificationsSpecificationId/
      Handler: app.lambda_handler
      Environment:
        Variables:
          SPECIFICATIONS_TABLE_NAME: !Ref SpecificationsTable
          USERS_TABLE_NAME: !Ref UsersTable
          CREATE_SPECIFICATION_SQS_QUEUE_URL: !Ref CreateSpecificationSQSQueue
          S3_BUCKET_SPECIFICATIONS: !Ref S3BucketSpecifications
      Role: !GetAtt SpecificationsSpecificationIdFunctionRole.Arn
      Events:
        GetSpecificationsSpecificationId:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/specifications/{specification_id}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        PutSpecificationsSpecificationId:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/specifications/{specification_id}
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
        DeleteSpecificationsSpecificationId:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/specifications/{specification_id}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer
      Layers:
        - !Ref CommonLayer

  #########################################################
  # specifications/{specificationId} Lambda関数のロググループの定義
  #########################################################
  SpecificationsSpecificationIdFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-specifications-specification-id
      RetentionInDays: 14

  #########################################################
  # specifications/{specificationId} Lambda関数のロールの定義
  #########################################################
  SpecificationsSpecificationIdFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-specifications-specification-id
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-specifications-specification-id
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:Query
                Resource: 
                  - !GetAtt SpecificationsTable.Arn
                  - !Sub ${SpecificationsTable.Arn}/index/TenantIdIndex
                  - !Sub ${SpecificationsTable.Arn}/index/SpecificationGroupIdIndex
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                Resource: !GetAtt SpecificationsTable.Arn
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource: !GetAtt CreateSpecificationSQSQueue.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub ${S3BucketSpecifications.Arn}/*
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-specifications-specification-id:*

  #########################################################
  # specifications/{specificationId}/download Lambda関数の定義
  #########################################################
  SpecificationsSpecificationIdDownloadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-specs-spec-id-download
      CodeUri: src/api/ApiSpecificationsSpecificationIdDownload/
      Handler: app.lambda_handler
      Environment:
        Variables:
          SPECIFICATIONS_TABLE_NAME: !Ref SpecificationsTable
          S3_BUCKET_SPECIFICATIONS: !Ref S3BucketSpecifications
      Role: !GetAtt SpecificationsSpecificationIdDownloadFunctionRole.Arn
      Events:
        PostSpecificationsSpecificationIdDownload:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/specifications/{specification_id}/download
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Layers:
        - !Ref CommonLayer

  #########################################################
  # specifications/{specificationId}/download Lambda関数のロググループの定義
  #########################################################
  SpecificationsSpecificationIdDownloadFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-specs-spec-id-download
      RetentionInDays: 14

  #########################################################
  # specifications/{specificationId}/download Lambda関数のロールの定義
  #########################################################
  SpecificationsSpecificationIdDownloadFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-specs-spec-id-download
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-specs-spec-id-download
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                Resource: !GetAtt SpecificationsTable.Arn
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !GetAtt S3BucketSpecifications.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub ${S3BucketSpecifications.Arn}/*
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-specs-spec-id-download:*

  #########################################################
  # CreateSpecificationSQSQueueの定義
  #########################################################
  CreateSpecificationSQSQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub queue-${ProjectName}-${ProjectType}-${Environment}-create-specification

  #########################################################
  # SQSキューからLambda関数をトリガーするための権限を追加
  #########################################################
  CreateSpecificationSQSQueuePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref CreateSpecificationFunction
      Principal: sqs.amazonaws.com
      SourceArn: !GetAtt CreateSpecificationSQSQueue.Arn

  #########################################################
  # CreateSpecificationFunctionの定義
  #########################################################
  CreateSpecificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-create-specification
      CodeUri: src/common/CreateSpecification/
      Handler: app.lambda_handler
      Runtime: nodejs18.x
      Environment:
        Variables:
          SPECIFICATIONS_TABLE_NAME: !Ref SpecificationsTable
          S3_BUCKET_SPECIFICATIONS: !Ref S3BucketSpecifications
      Role: !GetAtt CreateSpecificationFunctionRole.Arn
      Layers:
        - !Ref ChromiumLayer
      Events:
        CreateSpecification:
          Type: SQS
          Properties:
            Queue: !GetAtt CreateSpecificationSQSQueue.Arn
            BatchSize: 1
            Enabled: true
      Timeout: 300
      MemorySize: 2048

  #########################################################
  # CreateSpecificationFunctionのロググループの定義
  #########################################################
  CreateSpecificationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-create-specification
      RetentionInDays: 14

  #########################################################
  # CreateSpecificationFunctionのロールの定義
  #########################################################
  CreateSpecificationFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-create-specification
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-create-specification
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-create-specification:*
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                Resource: !GetAtt SpecificationsTable.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource: !Sub ${S3BucketSpecifications.Arn}/*
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !GetAtt S3BucketSpecifications.Arn
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                Resource: !GetAtt CreateSpecificationSQSQueue.Arn

  #########################################################
  # SpecificationGroupsSpecificationGroupIdFunctionの定義
  #########################################################
  SpecificationGroupsSpecificationGroupIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-specgroups-specgroup-id
      CodeUri: src/api/ApiSpecificationGroupsSpecificationGroupId/
      Handler: app.lambda_handler
      Environment:
        Variables:
          SPECIFICATIONS_TABLE_NAME: !Ref SpecificationsTable
          SPECIFICATION_GROUPS_TABLE_NAME: !Ref SpecificationGroupsTable
      Role: !GetAtt SpecificationGroupsSpecificationGroupIdFunctionRole.Arn
      Events:
        PutSpecificationGroupsSpecificationGroupId:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/specificationgroups/{specification_group_id}
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
        DeleteSpecificationGroupsSpecificationGroupId:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/specificationgroups/{specification_group_id}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer
      Layers:
        - !Ref CommonLayer

  #########################################################
  # SpecificationGroupsSpecificationGroupIdFunctionのロググループの定義
  #########################################################
  SpecificationGroupsSpecificationGroupIdFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-specgroups-specgroup-id
      RetentionInDays: 14

  #########################################################
  # SpecificationGroupsSpecificationGroupIdFunctionのロールの定義
  #########################################################
  SpecificationGroupsSpecificationGroupIdFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-specgroups-specgroup-id
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-specgroups-specgroup-id
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:Query
                Resource: 
                  - !GetAtt SpecificationsTable.Arn
                  - !Sub ${SpecificationsTable.Arn}/index/TenantIdIndex
                  - !Sub ${SpecificationsTable.Arn}/index/SpecificationGroupIdIndex
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                Resource: !GetAtt SpecificationGroupsTable.Arn
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-specgroups-specgroup-id:*

  #########################################################
  # SpecificationGroupsFunctionの定義
  #########################################################
  SpecificationGroupsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-specification-groups
      CodeUri: src/api/ApiSpecificationGroups/
      Handler: app.lambda_handler
      Environment:
        Variables:
          SPECIFICATION_GROUPS_TABLE_NAME: !Ref SpecificationGroupsTable
      Role: !GetAtt SpecificationGroupsFunctionRole.Arn
      Events:
        GetSpecificationGroups:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/specificationgroups
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        PostSpecificationGroups:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/specificationgroups
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Layers:
        - !Ref CommonLayer

  #########################################################
  # SpecificationGroupsFunctionのロググループの定義
  #########################################################
  SpecificationGroupsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-specification-groups
      RetentionInDays: 14

  #########################################################
  # SpecificationGroupsFunctionのロールの定義
  #########################################################
  SpecificationGroupsFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-specification-groups
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-specification-groups
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                Resource: !GetAtt SpecificationGroupsTable.Arn
              - Effect: Allow
                Action:
                  - dynamodb:Query
                Resource: !Sub ${SpecificationGroupsTable.Arn}/index/TenantIdIndex
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-specification-groups:*

  #########################################################
  # 画像アップロード用Lambda関数の定義
  #########################################################
  ImageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub function-${ProjectName}-${ProjectType}-${Environment}-image
      CodeUri: src/api/ApiImage/
      Handler: app.lambda_handler
      Environment:
        Variables:
          TENANT_TABLE_NAME: !Ref TenantsTable
          S3_BUCKET_SPECIFICATIONS: !Ref S3BucketSpecifications
          S3_BUCKET_STATIC_ASSETS: !Ref S3BucketStaticAssets
      Role: !GetAtt ImageFunctionRole.Arn
      Events:
        PostImage:
          Type: Api
          Properties:
            RestApiId: !Ref FloorStudiosApi
            Path: /v1/image
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Layers:
        - !Ref CommonLayer

  #########################################################
  # 画像アップロード用Lambda関数のロググループの定義
  #########################################################
  ImageFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-image
      RetentionInDays: 14

  #########################################################
  # 画像アップロード用Lambda関数のロールの定義
  #########################################################
  ImageFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub role-${ProjectName}-${ProjectType}-${Environment}-image
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub policy-${ProjectName}-${ProjectType}-${Environment}-image
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub ${S3BucketSpecifications.Arn}/*
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub ${S3BucketStaticAssets.Arn}/*
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                Resource: !GetAtt TenantsTable.Arn
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/function-${ProjectName}-${ProjectType}-${Environment}-image:*

  #########################################################
  # Tenantsテーブルの定義
  #########################################################
  TenantsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub table-${ProjectName}-${ProjectType}-${Environment}-tenants
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tenant_id
          AttributeType: S
        - AttributeName: kind
          AttributeType: S
      KeySchema:
        - AttributeName: tenant_id
          KeyType: HASH
        - AttributeName: kind
          KeyType: RANGE

  #########################################################
  # Usersテーブルの定義
  #########################################################
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub table-${ProjectName}-${ProjectType}-${Environment}-users
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: tenant_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: tenant_id
          KeyType: RANGE
      # テナントIDで検索するためのGSI
      GlobalSecondaryIndexes:
        - IndexName: TenantIdIndex
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  #########################################################
  # Specificationsテーブルの定義
  #########################################################
  SpecificationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub table-${ProjectName}-${ProjectType}-${Environment}-specifications
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: specification_id
          AttributeType: S
        - AttributeName: tenant_id
          AttributeType: S
        - AttributeName: specification_group_id
          AttributeType: S
        - AttributeName: tenant_id#status
          AttributeType: S
      KeySchema:
        - AttributeName: specification_id
          KeyType: HASH
        - AttributeName: tenant_id
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: TenantIdIndex
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: SpecificationGroupIdIndex
          KeySchema:
            - AttributeName: specification_group_id
              KeyType: HASH
            - AttributeName: tenant_id#status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  #########################################################
  # SpecificationGroupsテーブルの定義
  #########################################################
  SpecificationGroupsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub table-${ProjectName}-${ProjectType}-${Environment}-specification-groups
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: specification_group_id
          AttributeType: S
        - AttributeName: tenant_id
          AttributeType: S
      KeySchema:
        - AttributeName: specification_group_id
          KeyType: HASH
        - AttributeName: tenant_id
          KeyType: RANGE
      # テナントIDで検索するためのGSI
      GlobalSecondaryIndexes:
        - IndexName: TenantIdIndex
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  #########################################################
  # Lambda Layerの定義
  #########################################################
  CommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub layer-${ProjectName}-${ProjectType}-${Environment}-common
      Description: Common utilities for Floor Studios Core
      ContentUri: src/layer
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Retain

  #########################################################
  # Chromium Layerの定義
  #########################################################
  ChromiumLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub layer-${ProjectName}-${ProjectType}-${Environment}-chromium
      Description: Chromium for Floor Studios Core
      ContentUri: src/layer/chromium
      CompatibleRuntimes:
        - nodejs22.x
      RetentionPolicy: Retain

Outputs:
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref CognitoUserPool
  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref CognitoUserPoolClient
